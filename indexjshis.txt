let state = {
  hash: location.hash,
  contacts: [],
  searchValue: "",
  currentPage: 1,
  isLoading: false,
  errorMassage: "",
  totalData: 0,
};

function setState(newState) {
  const prevState = { ...state };
  const nextState = { ...state, ...newState };
  state = nextState;
  onStateChange(prevState, nextState);
  Render();
}

function onStateChange(prevState, nextState) {
  if (prevState.hash !== nextState.hash) {
    history.pushState(null, "", nextState.hash);
    setState({ searchValue: "" });
  }
  if (prevState.searchValue !== nextState.searchValue) {
    setState({ isLoading: true });
    fetchData();
  }
  if (prevState.isLoading !== nextState.isLoading) {
    filterContactList(nextState.searchValue);
  }
  if (prevState.currentPage !== nextState.currentPage) {
    fetchData();
  }
}

function Link(props) {
  const link = document.createElement("a");
  link.href = props.href;
  link.textContent = props.label;
  link.onclick = function (event) {
    event.preventDefault();
    const url = new URL(event.target.href);
    setState({ hash: url.hash });
  };
  return link;
}

function NavBar() {
  const linkHome = Link({
    href: "#home",
    label: "Home",
  });
  const linkFavorites = Link({
    href: "#favorites",
    label: "Favorites",
  });
  const div = document.createElement("div");
  div.append(linkHome);
  div.append(" - ");
  div.append(linkFavorites);
  return div;
}

function Pages() {
  const totalPage = Math.ceil(state.totalData / 10);
  let div = document.createElement("div");
  for (let index = 1; index <= totalPage; index++) {
    const link = document.createElement("a");
    const number = index;
    link.href = state.hash;
    link.textContent = index + " ";
    link.onclick = function (event) {
      setState({ currentPage: number });
      console.log(state.currentPage);
    };
    div.append(link);
  }
  return div;
}

function HeaderText(text) {
  const teks = document.createElement("h2");
  teks.innerText = text;
  return teks;
}

function InputText() {
  const input = document.createElement("input");
  input.type = "text";
  input.placeholder = "Enter Name";
  input.id = "input";
  input.value = state.searchValue;
  input.oninput = function (event) {
    setState({ searchValue: event.target.value });
  };
  return input;
}

function ClearButton(props) {
  const button = document.createElement("input");
  button.type = "button";
  button.value = props;
  button.value = props.value;
  button.onclick = function () {
    setState({ searchValue: "" });
  };
  return button;
}

function FavButton(props) {
  const button = document.createElement("input");
  button.type = "button";
  button.value = props.value;
  button.onclick = function () {
    setState({ searchValue: "" });
  };
  return button;
}

function ContactList() {
  const list = document.createElement("ol");
  list.start = (state.currentPage - 1) * 10 + 1;
  const items = state.contacts.map((data) => {
    const li = document.createElement("li");
    const fullname = document.createElement("p");
    const email = document.createElement("p");
    const button = FavButton({ value: "add to Favorite" });
    fullname.textContent =
      data.firstName + " " + data.maidenName + " " + data.lastName;
    email.textContent = data.email;
    li.append(fullname, email, button);
    return li;
  });
  list.append(...items);
  return list;
}

function fetchData() {
  fetch(
    "https://dummyjson.com/users/search?q=&skip=" +
      (state.currentPage - 1) * 10 +
      "&limit=10"
  )
    .then((result) => {
      return result.json();
    })
    .then((data) => {
      setState({
        contacts: [...data.users],
        totalData: data.total,
        isLoading: true,
      });
    })
    .catch((err) => {
      console.log(err);
      setState({ errorMassage: err });
    });
  setState({ isLoading: false });
}

function filterContactList(value) {
  const items = state.contacts.filter(filterName);
  function filterName(item) {
    const fullname = (
      item.firstName +
      " " +
      item.maidenName +
      " " +
      item.lastName
    ).toLowerCase();
    return fullname.match(value.toLowerCase());
  }
  setState({ contacts: [...items] });
}

function HomePage() {
  const navBar = NavBar();
  const header = HeaderText("Contact List");
  const input = InputText();
  const button = ClearButton({
    value: "Clear",
  });
  const list = ContactList();
  const page = Pages();
  const div = document.createElement("div");
  div.append(navBar);
  div.append(header);
  div.append(input);
  div.append(button);
  div.append(list);
  div.append(page);
  return div;
}

function FavoritesPage() {
  const navBar = NavBar();
  const header = HeaderText("Favorite Contact List");
  const input = InputText();
  const button = ClearButton({
    value: "Clear",
  });
  const div = document.createElement("div");
  div.append(navBar);
  div.append(header);
  div.append(input);
  div.append(button);
  return div;
}

function App() {
  const homepage = HomePage();
  const favoritespage = FavoritesPage();
  if (state.hash === "#home" || state.hash === "") {
    return homepage;
  } else if (state.hash === "#favorites") {
    return favoritespage;
  }
}

function Render() {
  const root = document.getElementById("root");
  const app = App();
  const focusedIdElement = document.activeElement.id;
  const focusedElementSelectionStart = document.activeElement.selectionStart;
  const focusedElementSelectionEnd = document.activeElement.selectionEnd;
  root.innerHTML = "";
  root.append(app);
  if (focusedIdElement) {
    const focusedElement = document.getElementById(focusedIdElement);
    focusedElement.focus();
    focusedElement.selectionStart = focusedElementSelectionStart;
    focusedElement.selectionEnd = focusedElementSelectionEnd;
  }
}

Render();
onStateChange({}, state);
